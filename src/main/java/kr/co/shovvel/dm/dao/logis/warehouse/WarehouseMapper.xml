<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://www.mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.shovvel.dm.dao.logis.warehouse.WarehouseMapper">

    <select id="getProductInfo" resultType="kr.co.shovvel.dm.domain.management.pay.SellerProductInfoVO">
        SELECT *
        FROM seller_product_info
    </select>

    <!-- 해당 유저와 관련된 창고 신청 내역을 조회한다. -->
    <select id="searchWarehouseOrderInfo" parameterType="string"
            resultType="kr.co.shovvel.dm.domain.logis.search.WarehouseSearchInfo">
        SELECT ORDER_INFO_UID, USER_UID, DATE_FORMAT(START_TIME,'%Y-%m-%d %H:%i') AS START_TIME,
        DATE_FORMAT(END_TIME,'%Y-%m-%d %H:%i') AS END_TIME,
        w.WAREHOUSE_NAME AS WAREHOUSE_NAME, SIZE, DATE(REQUEST_TIME) AS REQUEST_TIME, STATUS, woi.PRICE AS PRICE,
        PAY_TYPE, IS_PAY
        FROM warehouse_order_info AS woi
        JOIN warehouse AS w ON woi.WAREHOUSE_UID = w.WAREHOUSE_UID
        <![CDATA[
        WHERE USER_UID = #{userUid} AND STATUS >= 1
        ]]>
        ORDER BY ORDER_INFO_UID DESC;
    </select>
    
    <!-- 빌려준 창고 내역 조회 -->
    <select id="serchRentWarehouse" parameterType="string"
            resultType="kr.co.shovvel.dm.domain.logis.search.WarehouseSearchInfo">
        <![CDATA[
	        SELECT 
	        	ORDER_INFO_UID, 
	        	woi.USER_UID, 
	        	DATE_FORMAT(START_TIME,'%Y-%m-%d %H:%i') AS START_TIME,
	        	DATE_FORMAT(END_TIME,'%Y-%m-%d %H:%i') AS END_TIME,
	        	w.WAREHOUSE_NAME AS WAREHOUSE_NAME, 
	        	SIZE, 
	        	DATE(REQUEST_TIME) AS REQUEST_TIME, 
	        	woi.STATUS, 
	        	woi.PRICE AS PRICE,
	        	PAY_TYPE, 
	        	IS_PAY
	        FROM warehouse_order_info AS woi
	        JOIN warehouse AS w ON woi.WAREHOUSE_UID = w.WAREHOUSE_UID
	        JOIN user_company AS uc ON uc.WAREHOUSE_UID = w.WAREHOUSE_UID
	        JOIN user  AS u ON u.COMPANY_UID = uc.COMPANY_UID
	        WHERE 
	        	u.USER_UID =#{userUid} 
	        AND 
	        	now() < woi.END_TIME
	        ORDER BY woi.REQUEST_TIME DESC
        ]]>
    </select>
    
     <!-- 빌려준 창고 과거 내역 조회 -->
    <select id="serchRentWarehouseBefore" parameterType="string"
            resultType="kr.co.shovvel.dm.domain.logis.search.WarehouseSearchInfo">
        <![CDATA[
	        SELECT 
	        	ORDER_INFO_UID, 
	        	woi.USER_UID, 
	        	DATE_FORMAT(START_TIME,'%Y-%m-%d %H:%i') AS START_TIME,
	        	DATE_FORMAT(END_TIME,'%Y-%m-%d %H:%i') AS END_TIME,
	        	w.WAREHOUSE_NAME AS WAREHOUSE_NAME, 
	        	SIZE, 
	        	DATE(REQUEST_TIME) AS REQUEST_TIME, 
	        	woi.STATUS, 
	        	woi.PRICE AS PRICE,
	        	PAY_TYPE, 
	        	IS_PAY
	        FROM warehouse_order_info AS woi
	        JOIN warehouse AS w ON woi.WAREHOUSE_UID = w.WAREHOUSE_UID
	        JOIN user_company AS uc ON uc.WAREHOUSE_UID = w.WAREHOUSE_UID
	        JOIN user  AS u ON u.COMPANY_UID = uc.COMPANY_UID
	        WHERE 
	        	u.USER_UID =#{userUid} 
	        AND 
	        	now() > woi.END_TIME
	        ORDER BY woi.REQUEST_TIME DESC
        ]]>
    </select>
    

    <select id="searchWarehouseOrderInfoDetail" parameterType="string"
            resultType="kr.co.shovvel.dm.domain.logis.search.WarehouseSearchInfo">
        SELECT ORDER_INFO_UID,USER_UID, DATE_FORMAT(START_TIME,'%Y-%m-%d %H:%i') AS START_TIME, w.WAREHOUSE_NAME AS
        WAREHOUSE_NAME, WAREHOUSE_ADDRESS,
        DATE_FORMAT(END_TIME,'%Y-%m-%d %H:%i') AS END_TIME, SIZE, DATE(REQUEST_TIME) AS REQUEST_TIME, STATUS, woi.PRICE
        AS PRICE, PAY_TYPE, IS_PAY
        FROM warehouse_order_info AS woi
        JOIN warehouse AS w ON woi.WAREHOUSE_UID = w.WAREHOUSE_UID
        WHERE ORDER_INFO_UID = #{orderInfoUid}
    </select>

    <!-- 현재 로그인한 사용자의 회사 위치를 조회한다. -->
    <select id="searchComapanyAddress" parameterType="string" resultType="string">
        SELECT ADDRESS
        FROM user u, user_company uc
        WHERE u.COMPANY_UID = uc.COMPANY_UID
        AND u.USER_UID = #{userUid};
    </select>

    <!-- 창고 공유 신청 -->
    <insert id="addWarehouseLend" parameterType="kr.co.shovvel.dm.domain.logis.warehouse.WarehouseLendInfo"
            useGeneratedKeys="true" keyProperty="lendOrderUid">
        INSERT INTO warehouse_lend_order(USER_UID, WAREHOUSE_NAME, COMPANY_NAME, PHONE_NUMBER, WAREHOUSE_ADDRESS,
                                         WAREHOUSE_POSTCODE, WAREHOUSE_SIZE, SPACE_PRICE)
        VALUES (#{userUid}, #{warehouseName}, #{companyName}, #{phoneNumber}, #{warehouseAddress}, #{warehousePostcode},
                #{warehouseSize}, #{spacePrice});
    </insert>

    <select id="searchCompanyUid" parameterType="int" resultType="int">
        SELECT COMPANY_UID
        FROM user
        WHERE USER_UID = #{userUid};
    </select>
</mapper>
